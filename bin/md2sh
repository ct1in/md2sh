#!/bin/bash

if [[ 0 -eq $# ]]
then
	cat << EOF
USAGE: ${0##*/} [MD_FILEs]
EOF
	exit 0
fi

for foo
do
	[[ -s $foo ]] || continue

	( awk '
BEGIN {
	prefix = ":"
	in_block = 0
}

/^[ \t]*``` shell[ \t]*$/ {
	# Calculate indentation length
	indent = match($0, /[^ \t]/) - 1
	indent_str = substr($0, 1, indent)

	printf "%s <<- '\''%s``` shell'\''; sed '\''s/^%s//'\'' <<- '\''%s```'\''",
	prefix, indent_str, indent_str, indent_str

	prefix = ";"
	in_block = 1
	next
}

/^[ \t]*```[ \t]*$/ && in_block {
	in_block = 0
	next
}

END {
	print "; <<- EOF"
}
' "$foo"
	cat "$foo"
	) | sh
done

exit 0